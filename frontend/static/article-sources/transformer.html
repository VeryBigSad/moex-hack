<h2>Введение</h2>
<p>
    Многие datascientists, желающие использовать ML на финансовых рынках, прочитали толстые книжки об инвестировании,
    может даже создавали модели с учетом прочитанного. И наверняка знают как правильно оценить полученные модели с точки
    зрения ML. Разобраться с этим необходимо, чтобы не было мучительно больно, когда прекрасная модель на бумаге,
    превращается в генератор убытков при практическом использовании. Однако оценка эффективности модели ML на бирже,
    довольно специфическая область, тонкости которой раскрываются только когда вы погружаетесь в процесс. Под процессом
    я понимаю трейдинг с частотой совершения сделок гораздо чаще "пара сделок в месяц, в течении полугода". Существует
    множество подводных камней, о наличии которых вы даже не подозреваете, пока смотрите на трейдинг извне. Я попробую
    вольно изложить свои мысли на данную тему, я покажу метрики, условно разбив их на 3 группы и обьясню их смысл,
    покажу свои любимые и о чем нужно подумать, если вы хотите практически использовать модели, а не повесить их на
    стеночку в красивой рамочке. Представлю метрики в табличном и графическом виде, показав их взаимосвязь. Сравню
    показатели моделей в виде "какую модель выбираю я" и "что выбираете вы" и кто тут больше ошибается. Для любителей
    кодов, приведу реализацию всего подсчитанного, так что можно сразу применить прочитанное для оценки своих моделей. Я
    не буду тут говорить о борьбе с переобучением или регуляризации или стратегиях кросвалидации - оставлю это на потом.
    Здесь мы начинаем со списка уже спрогнозированных сделок, с помощью transformer о которой я писал в прошлой статье.
    Поэтому данный текст будет его логическим продолжением, где я оценю модель с точки зрения ее практического
    использования.
</p>

<h2>1. Раздел где я собрал все оценки моделей на бирже и разбил их на 3 группы.</h2>
<p>
    Существует несколько способов оценки эффективности модели, которые можно условно разбить по степени вовлеченности в
    реальный трейдинг. Не очень вовлеченные часто останавливаются на первом уровне, это метрики ML, в частности для
    задачи классификации это будет accuraсy и ее производные. Прямо скажем эти показатели далеки от того что
    действительно интересует людей которые приходят на биржу. Там знаете ли, всех интересует финансовый результат.
    Языком ML это можно назвать бизнес метрикой - то что мы получим при использовании модели в денежном выражении. Я
    мало смотрю на показатели типа accuracy, сразу конвертируя прогнозы в финансовый результат, а если datascientist
    демонстрирует accursay, roc-auc итд, но упорно отказывается продемонстрировать сколько можно было бы заработать
    используя модель, то скорей всего это говорит, о сомнительном финрезультате или о недопонимании для чего все это
    нужно. Или например приводят фактический и спрогнозированный график цен и умиляются их близостью, хотя все что
    модель делает - прогнозирует на завтра сегодняшнюю цену. Такая вот хорошечность. Такой подлог даже вооружившись
    лупой можно не разглядеть, а с приведенным финансовым результатом все сразу становится на свои места. Даже если вы
    не шарлатан от машинного обучение, и все посчитали корректно, показатели ML не говорит практически ни о чем.
    Например будет ли прибыльной модель угадывающая 80% движений на тик или минуту вперед? Нет, потому что за тик или
    минуту, цена просто не проходит такое расстояние чтобы покрыть комиссию и проскальзывание.
</p>
<p>
    Говоря о "бизнес метриках" надо понимать, что уже существует широкий набор показателей, продемонстрировавшие свою
    эффективность при выборе алгоритмических моделей. И нейронщикам ничего придумывать не нужно, просто берем заботливо
    создано задолго до нас. Если говорить о концепции лежащей в основе, то многие из них вертятся вокруг идеи измерения
    соотношения риск-доход, чем меньший риск Y мы принимаем для того чтобы получить доход X - тем лучше. Тут же рядом
    как феникс появляются "безрисковый доход", "дисконтирование", "будущая стоимость", "корреляция активов",
    "портфельное инвестирование" и другие понятия из экономтеории. На этих идеях построены классические модели
    инвестирования, разной сомнительности, за которые тем не менее были получены Нобелевские премии. При этом допустимое
    соотношение риск-доходность это выбор каждого человека, но имея для каждой модели такое вот соотношение их можно
    сравнивать между собой, приведя к одному основанию и говорить что модель 1 позволяет получить прибыль больше чем
    модель 2 при одинаковом уровне рисков.
</p>
<p>
    Так вот, показателей из разряда бизнес - метрик (которые я условно причислю к второй группе показателей) очень
    много: Sharp Ratio, Profit Factor, Recovery Factor, Payoff Ratio, Maximum Drawdown %, Max Consecutive Losses
    (Winners), Average Time Held, Loss Rate, Win Rate, Average Profit (Loss), Exposure, Net Profit, Profit Distribution.
    Казалось, зачем так много показателей, если можно например взять число сделок, умножить на среднюю прибыльность
    сделки и получить Net Profit - то куда мы придем используя модель. На самом деле все не так, двигаться из А в
    сторону Б можно очень по разному, на пути может существовать точка невозврата С, попав в которую до никакого Б мы
    уже не дойдем. Например в силу катастрофических просадках по счету, достигающих более 50% по счету. Это простая
    арифметика - если вы упали от локального максимума по своему счету на - 50%, то чтобы вернуться к достигнутому
    максимуму вам понадобиться сделать уже не +50%, а +100%, и я не говорю о более сильных просадках, которые уж точно
    являются точками невозврата. Точка невозврата может быть связанна с таким психологическим состоянием трейдера,
    которое никак не совместимо с трейдингом. По показателю Net Profit мы это никогда не увидим, тут надо считать все
    эти показатели, либо строить кривую изменения вашего счета по времени - Equity. Правильно сгенерированная Equity
    дает исчерпывающий ответ о эффективности вашей модели, а весь тот большой набор данных, который я привел выше,
    описывает разные аспекты этой кривой. Еще один вариант, это взять наши сделки и сгенерировать много выборок меняя
    очередность сделок, а затем посчитать долю случаев в которых неблагоприятный период в виде подряд шедших убыточных
    сделок настолько затянулся, что привел к попаданию в точку невозврата, когда до хорошей серии сделок мы уже не
    доживем. Говоря языком матстатистики - выдвигаем гипотезу H0, альтернативную, выбираем уровень значимости, строим
    статистику на основе верности гипотезы H0 и принимаем или отвергаем ее. И тут опять может так получиться что вполне
    пристойные модели с точки зрения Net Profit, с точки зрения матстатистики окажутся не хороши, например модели с
    небольшим числом сделок. И тут мы переходим к третьей группе показателей эффективности модели.
</p>
<p>
    Третья группа, под некоторые можно подвести теорию, некоторые проистекают из здравого смысла, из моего опыта, а
    некоторые не имеют ни одного ни второго ни третьего, но они соответствуют моему психотипу. Под последним можно
    понимать, порог чувствительности при просадках, готовность сидеть весь день за компьютером, отслеживая ситуацию,
    приемлемое для вас соотношение риск-доходность, частота прибыльных сделок итп итд. Модель может быть эффективной по
    бизнес-метрикам, но вы не сможете ее торговать, потому что она для вас некомфортна. Например мне не комфортно
    торговать модели, которые каждый год надо полностью переучивать, или модели типа "ловля ножей". Эти никак не оценить
    ни метриками ML, ни "бизнес метриками", ни строя кривые equity, это из другой оперы. Вот есть модель, а есть трейдер
    ее использующий и эффективность будет зависеть и от модели и от того кто ее использует и если модель не является
    продолжением трейдера - вы используете чужую модель, или сомневаетесь в ней, то ничего хорошего может не получиться,
    хотя по отдельности все вроде бы и хорошо. Некоторые пытаются обходить этот момент, самоустраняясь, перепоручая все
    роботу. Такая обезличенность в некотором смысле оправданна. Я могу привести множество примеров когда успешная или
    неуспешная сделка накануне, подсознательно влияла на принятие решения о следующей сделке. Поэтому я старательно
    пытаюсь стирать из памяти (и фигурально и фактически) все прошлые сделки.
</p>
<p>
    Или например добавлю немножко "кота Шредингера". Это о вашем влияние на рынок. Частично именно этим можно обьяснить
    почему на тесте и при использовании модели, ваши результаты разьезжаются. И влияние этого фактора тем больше чем
    большее влияние вы оказываете на котировку акции своими сделками. Вы получили модель тестируя ее на торгах где вас
    не было - одна реальность, когда вы начинаете торговать, вы изменяете действительность. Если совершая сделку, вы
    двигаете цену на десятые доли процента, то поздравляю - вы манипулятор. Опять же это не история о абсолютном зле,
    экономика это вообще не история о каких то предельных понятиях, это история о балансе (баланс между инфляцией и
    экономическим ростом). Двигая рынок, вы вполне можете оказаться тем камушком который опрокинет рынок в нужную вам
    сторону, или не в нужную. Направление этого влияния мы скорей всего никак не замерим, зато можем оценить "ликвидную
    емкость модели" (термин самопридуманный), который позволяет оценить эффективность модели с условием что мы не меняем
    реальность. Это критерий эффективности модели из здравого смысла, который многие начинают учитывать только когда
    визуально наблюдают как не могут набрать позицию одним кликом.
</p>

<h2>2. Раздел, вывод которого о Equity как исчерпывающе характеризующим эффективность системы. </h2>
<p>
    Давайте начнем оценивать transformer, начнем с бизнес-метрик, но сначала о данных. Обучив несколько вариантов
    transformer, я прогнал их на новых данных, получив поток сделок, к которым добавил столбец с прогнозом роста, от
    каждой модели, в виде вероятности. В итоге имеем pandas dataframe, со следующими столбцами: ['Date', 'Symbol',
    'profit_label', 'profit', forecast_model1, forecast_model2, ... forecast_modelN']. Теперь надо разобраться что нам
    делать сразу с несколькими прогнозами. В моих функциях реализовано несколько стратегий стакинга (по максимальной
    уверенности среди всех моделей, по средней уверенности, по минимальной, по числу голосов с каким то порогом
    уверенности). Разница в результатах не принципиальная, но чтобы не путаться, все последующие результаты взяты из
    правила - "покупаем если по акции сработал сигнал с уверенностью выше 0,6, от более чем 1 модели".
</p>
<p>
    Самый простой вариант финансового результата, это Net Profit с разбивкой по количеству сделок и средним профитом на
    сделку, и в группировке по годам.
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/d3b/a4d/78a/d3ba4d78a306e623bd9f53718cf08581.png"
    alt="" width="300px" />
<p>
    Однако не все так просто. Мы ведь торгуем не в сферическом вакууме, у нас есть обьективные ограничения в виде
    размера счета (с учетом маржинальной позиции), мы не можем одновременно на каждую сделку выделить 100% возможных
    средств. Приведу предельный пример несуразицы, после которого станет все понятно. Допустим у вас есть модель которая
    генерирует 40 сигналов в год и каждая сделка приносит в среднем по 1%. А теперь представим что все сигналы по этой
    модели срабатывают одновременно. И теперь вместо модели которая генерирует 40% годовых, мы становимся гордыми
    обладателями модели которая генерирует 1% годовых. То есть мы говорим о перекрещивание сделок. Я изобразил это на
    рисунке, не то чтобы без него было непонятно, но рисунки разнообразят текст да и может здесь кроме любителей читать
    есть любители рассматривать картинки. На картинке ниже, в формате "каракули" я изобразил 7 сигналов : 1 и 2, 3 и 4,
    5 и 6 - сигналы появились одновременно, причем 1, 3 и 4 сигналы, по отношению к сигналам 2, 4 и 5, приоритетные, то
    есть по ним модель более уверенна. Время удержания позиции - длина черты.
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/21a/68e/9bf/21a68e9bf44d02bb55794577d2f25198.png"
    alt="" />
<p>
    Пусть первая сделка принесла +1%, а каждая следующая на 1% больше (то есть номер сигнала совпадает с прибыльностью
    сделки), вопрос сколько мы заработали в % к нашему счету (без реинвестирования)? Если сигналы появились
    одновременно, то мы должны выбрать какую то одну или взять все, но прибыль считать как взвешенную по доле участия
    капиталом в каждой сделке. Пока мы не выйдем из предыдущей сделки, высвободив кэш, в новую не входим. Если входим
    равными долями, тогда получается 3 сделки (все сделки совершенные в одно время я буду считать одной сделкой):
    (0,5%+1%) + (2,5%+3%) + (3,5%). А если например мы входим на 100%, по самому перспективному сигналу, тогда 3 сделки:
    1%+3%+5%. А если например степень уверенности конвертировать в долю участия по этому сигналу, то третий вариант, А
    если например учитывать ликвидность, то четвертый вариант, я его рассмотрю ниже. Варианты разные и каждый раз мы
    будем получать разные итоги. А если вообще не думать, то получится 7 сделок 1+2+3+4+5+6+7.
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/2c6/ba3/2e3/2c6ba32e31ae24e02f75a7566a2979d8.png"
    alt="" width="300px" />
<p>
    Мы не думать не будем, поэтому подкорректируем результат, случай когда берем среднюю по сделкам - размазываем
    капитал по акция в равных долях:
</p>
<p>
    И результат когда входим на 100% входим в сделку с наивысшим приоритетом:
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/449/b8e/f51/449b8ef51747c61281b634b28ffc4946.png"
    alt="" width="300px" />
<p>
    Убрав эффект перекрещивающихся сделок, видим что эффективность модели упала - число сделок уменьшилось и средняя
    прибыльность снизилась, но не катастрофически. Кодик для подсчета Net Profit в данном виде:
</p>
<pre><code>def trade_list(df_data_conect, for_treshold, treshold, mean__, count_tresh, time_time4_dtime, time_list, name_profit):

    print(f'Profit: {name_profit}, Feature: {for_treshold}')
    if mean__ == 'mean':
      mean__1 = df_data_conect[for_treshold].mean(axis = 1)
    elif mean__ == 'max':
      mean__1 = df_data_conect[for_treshold].max(axis = 1)
    elif mean__ == 'min':
      mean__1 = df_data_conect[for_treshold].min(axis = 1)
    elif mean__ == 'count':
      mean__1 = (df_data_conect[for_treshold] > count_tresh).sum(axis = 1)
    df_data_conect.Date = pd.to_datetime(df_data_conect.Date)
  
    df_data_conect['mean__'] = np.array(mean__1)
  
    pivo_lon1 = pd.pivot_table(df_data_conect[df_data_conect['mean__'] >= treshold],
                  index = [df_data_conect.Date.dt.date, 'Symbol'],
                  values = ['mean__', name_profit],
                  ).T.drop_duplicates().T
    pivo_lon1.reset_index(inplace=True)
    pivo_lon1 = pivo_lon1.sort_values(['Date', 'mean__'], ascending = [True, False], ignore_index=True) 
    pivo_lon1['Date'] = pd.to_datetime(pivo_lon1['Date'])
    pivo_lon1['long1'] = np.where(pivo_lon1['Date'].shift(0) != pivo_lon1['Date'].shift(1), 1, 0)
    
    print('all_trades')
  
    all_trades = pd.pivot_table(pivo_lon1,
          index = pivo_lon1['Date'].dt.year,
          values = [name_profit],
          aggfunc = ['count', 'mean'],
          margins = True
    )
    all_trades.columns = ['count_trades', 'profit%_per_trade']
    display(all_trades)
  
    print('long1')
  
    only_long1 = pivo_lon1[pivo_lon1['long1'] == 1]
    temp = pd.pivot_table(only_long1,
          index = pivo_lon1['Date'].dt.year,
          values = [name_profit],
          aggfunc = ['count', 'mean'],
          margins = True
    )
    temp.columns = ['count_day', 'profit%_day']
    display(temp)
  
    # Mean_day
    only_mean = df_data_conect[(mean__1 >= treshold)]
    pivo_long = pd.pivot_table(only_mean,
                  index = [df_data_conect.Date.dt.date],
                  values = [name_profit],
                  aggfunc = ['mean', 'count'],
                  margins = True
                  ).T.drop_duplicates().T
  
    pivo_long.reset_index(inplace = True)
    pivo_long.columns = ['Date', 'mean', 'count']
    pivo_long = pivo_long.iloc[:-1,:]
    pivo_long['Date'] = pd.to_datetime(pivo_long['Date'])
    
    print('mean')
    
    mean_profit = (pd.pivot_table(pivo_long,
                  index = pivo_long.Date.dt.year,
                  values = 'mean',
                  aggfunc = ['count', 'mean'],
                  margins = True
                  ))
    mean_profit.columns = ['count_day', 'profit%_day']
    display(mean_profit)
    # List_trades and mean_day
    print('List_trades')
    pivo_long = pd.pivot_table(df_data_conect[df_data_conect['mean__'] >= treshold],
                  index = [df_data_conect.Date.dt.date, 'Symbol'],
                  values = [name_profit, 'mean__', 'Volume_mean_10bars'],
                  aggfunc = ['mean'],
                  margins = True
                  ).T.drop_duplicates().T
  
    pivo_long.columns = pivo_long.columns.get_level_values(1)
    pivo_long.reset_index(inplace = True)
    pivo_long.sort_values(by = ['Date', 'mean__'], ascending = [True, False], inplace = True)
    
    display(pivo_long.tail(29))
  
    return only_long1, only_mean</code></pre>
<p>
    В аргументах функции trade_list мы имеем возможность выбрать стратегию стакинга, после чего получаем все указанные
    выше таблички. Нужно сказать что в случаи c transformer код очень сильно упрощен, достаточно все отсортировать по
    времени и применить много, много pd.pivot_table, так как для данного transformer время входа и выхода из позиции
    унифицирован. Если это не выполняется, то тут уже необходимо пробегаться в цикле по всем сделкам, расставляя флаги 0
    (нет позиций), 1 (вход в позицию), 2 (удержание позиции), 3 (выход из позиции), и исходя их этого считать Net
    Profit, по крайней мере так поступал я.
</p>
<p>
    Насколько перекрещивание сделок распространенно и насколько сильно учет их может ухудшить показатели модели?! Скажем
    так, в моей практике было несколько случаев когда я находил алгоритмы, которые а из разряда "перспективных"
    превращались в "неинтересные". Конечно пытливый ум человека сразу предлагал другой вариант - "если модель особо
    прибыльна когда по ней одновременно проходят сигналы по многим акциям, и таких случаев 10-12 раз а год, то может
    стоит глянуть что происходит на рынке после этого в среднесрочной перспективе?". Могу привести самый свежий пример
    по одному алгоритму, сигналы по которому я не использую, в силу большого числа перекрещивания. 18 января сего года
    по нему сработал сигнал сразу по 18 акциям. Смотрим на индекс МосБиржи и видим что это был локальное дно, после
    которого рынок перестал падать. 23 декабря прошлого года по этому алгоритму сработал сигнал сразу по 13 акциям.
    Смотрим на график индекса и видим - в следующие полторы недели рынок довольно активно рос. Отматываем историю дальше
    и опять видим такие случаи. Я такое не торгую, так как мало случаев, но может кому то идею подкину.
</p>
<p>
    Eсли вы пользуетесь Take Profit, Stop Loss, может возникнуть следующий момент который может исказить эффективность
    вашей модели. В коде вы можете поставить приоритет Take Profit, но никакого приоритета он не имеет, приоритет имеет
    первое произошедшее по времени. Работая с баром, вы не знаете что первым наступит - первое или второе, а это большая
    разница когда вы выходите по Take Profit или закрываетесь по Stop Loss. Чем на большем таймфрейме вы тестируете
    систему, и чем меньше у вас разница между stop и take, тем больше вероятность попасть в ситуацию когда на одном баре
    происходит касание и линии take profit и линии stop loss. На рисунке я справа изобразил котировку в дневном
    представлении, а слева в 15 минутном
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/194/cf3/ad0/194cf3ad0a7e624e334ee284aa59e41c.png"
    alt="" />
<p>
    На левом баре мы не понимаем что сработало первым, на правом графике все понятно. Конечно и 15 минутного таймфремя
    может не хватить, абсолютное спасение это смотреть тики, но это какой то запредельный случай. Для моей модели это не
    актуально, но тем кто использует близкие стопы, стоит обратить внимание. То же самое касается цены открытия дня.
    Если кто то считает по ней входы-выходы, то он оперирует мифом, "цена открытия" это нечто иллюзорное, лучше вместо
    нее брать цену после 1 минуты торгов. Ну это так, к слову.
</p>
<p>
    Следующие показатели мы будем рассматривать вместе с equity, по принципу "единство и борьба противоположностей". Как
    я уже писал, все бизнес метрики являются всего лишь табличным представлением особенностей кривой equity. Рассмотрев
    все вместе, мы лучше сможем понять что к чему и зачем. Многие сравнивают кривые equity с индексами, я от этого также
    не удержусь. Логика простая - существует класс участников биржи, которые называют себя гордым словом "инвесторы",
    они читают советы Уоррена Баффета и прочих гуру. Находятся в поиске "мало рискованных, стабильных, растущих
    компаний". Одним словом занимаются ерундой. Немножко поумнев, они бросают бесплодные занятие найти то чего нет и
    просто покупают какой то индекс, в расчете на общий рост рынка, и они правы, инфляция знаете ли. И сравнение equity
    какой то модели с индексом, это такое противопоставление активного и пассивного трейдинга (buy and hold). И если ваш
    активный трейдинг не позволяет опередить пассивный, если прибыль по нему меньше чем по пассивному, если просадки по
    нему глубже чем по пассивному, то к чему это вся суета с беготней по рынку?! Чтобы накормить комиссией брокера?! С
    другой стороны, есть момент некорректности в таком подходе, например если трейдер играет исключительно в шорт (такая
    у него специализация), то как сравнивать его результаты с buy and hold?! Ведь при buy and hold торговле вы получаете
    прибыль когда рынок растет, а по шортовой, чем глубже рынок падает, тем удачней вы реализуете шортовые стратегии.
    Или даже если не шортовые стратегии, а самые что ни на есть длинные. Кто сказал что найденные вами лонговые паттерны
    лучше всего отработают при бурно растущем рынке?! В общем есть тут обманка, натягивание совы на глобус, поэтому я
    уже давно не оцениваю свои модели сравнивая их с пассивным инвестированием, я оцениваю их с точки зрения собственных
    критериев, например возможности получения стабильно 50% в год при заданном уровне риска. Поэтому я буду наносить на
    один график equity и индекс IMOEX чтобы был понятен масштаб. Есть небольшой вопрос - как считать equity: с
    реинвестированием или без. Отсутствие реинвестирования здорово искажает результаты, однако с реинвестированием,
    кривая индекса растворяется где то внизу и наглядность теряется. Промежуточный вариант - с реинвестированием, но
    входим только на 50% от капитала:
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/ef7/b01/46c/ef7b0146ce1d68ec44006115c2cb3324.png"
    alt="" />

<p>
    А теперь попробуем на этих графиках обозначить табличные данные. Number of bars since last Equity High (число баров
    с последнего обновленного максимума equity). Очень полезный показатель характеризующий способность вашей модели
    стабильно приносить прибыль. Черными линиями указал некоторые наиболее длительные промежутки, когда роста счета не
    было.
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/51f/474/66e/51f47466e319cbe541093a326bdbc734.png"
    alt="" width="400px" />
<p>
    А вот на кривой equity мы обозначаем наиболее крупные показатель Maximum Drawdown %: Находим локальный максимум и
    считаем в процентах откат до локального минимума.
</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/131/c02/c04/131c02c04de6b19016c5be6fe8be8642.png"
    alt="" width="400px" />
<p>Конечно нас интересует не выборочно самые большие значения, а некая динамика, поэтому разнесем показатели по шкале
    времени, для обоих графиков:</p>
<img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/8d1/464/ad2/8d1464ad203efe23c8bee838e5dbdbaf.png"
    alt="" width="400px" />
<p>По нижнему графику мы можем видеть как купив индекс ММВБ в январе 2020 года мы могли получить просадку по счету в
    размере -45%. По второму снизу, как купив индекс в 2012 году, нам бы пришлось ждать долгих 500 дней (3 года) пока
    наконец то не была бы получена первая прибыль. Верхние два демонстрируют что риски по transformer в разы ниже, а
    стабильность в получении прибыли в разы выше. Фрагмент кода для расчета этих показателей: </p>
<pre><code>for i in range(len(equity_max)):
    if i == 0:
      equity_max[i] = equity_from_plot[i]
    else:
      equity_max[i] = (equity_from_plot[:i+1]).max()

  for_plot['equity_max'] = equity_max

  ddown_bar = []
  for i in range(len(for_plot)):
    if i == 0:
      k = 0
    elif equity_max[i] == equity_max[i - 1]:
      k += 1
    else:
      k = 1
    ddown_bar.append(k)

  for_plot['Number_bar'] = ddown_bar

  for_plot['DrawDown_%'] = (for_plot['equity_max'] / equity_from_plot - 1) * 100</code></pre>
<p>Показатели соединяющие прибыль и риск: Recovery Factor - отношение прибыли в течении какого то временного промежутка
    к максимальной просадке и Profit Factor - рассчитывается как валовая прибыль, деленная на валовой убыток, таким
    образом, мы получаем число, которое показывает нашу прибыль, рассчитанную на единицу риска.</p>
<h2>Бонус</h2>
<p>
    Бонусом для моих читателей (как оказалось у меня уже появляются постоянные читатели, для которых я становлюсь
    источником некоторых оригинальных идей) напишу как я представляю процесс ценообразования на фондовых рынках. Недавно
    у меня была беседа в ходе которой был задан такой вопрос. Подозреваю мой ответ был несколько сумбурен, я начал
    приводить какие то аналогии с машиной, сейчас на спокойную голову я готов пофилософствовать на эту тему более
    подробно, на том же примере. Мы все знаем что существуют новости, на которые реагируют цены, есть реальная
    экономика, есть противоположно направленная денежно-кредитная политика центральных банков и министерств финансов
    (развития), есть люди которые приходят на фондовый рынок, причем с разными целями. Кто то покупает акции в целях
    извлечения прибыли, кто то выступает в качестве стратегических инвесторов. Для последних, прибыль не является целью,
    они будут держать акции даже при уверенности в падающих ценах. Ведь обладание акциями дает право голосовать на
    собраниях акционеров, и какие-нибудь условные немцы будут держать акции какого то условного Газпрома, в каком-нибудь
    условном 2008 году, потому что это необходимо для их геоэкономических стратегий по обеспечению национальной
    безопасности. Есть биржа - финансовый институт, который исполняет функцию перераспределения ресурсов, дублируя
    коммерческие банки, так по крайней мере нам рассказывали в финансовых Вузах. Есть страна где точно такое происходит
    - это США, где фондовый рынок действительно является, чем то большим чем в России, или любой другой стране мира, и
    изза истории и изза процента вовлеченных в торговлю населения, и изза активного перераспределения ресурсов. Я
    намешал все в кучу - новости, реальная экономика, биржа как институт, агенты действующие на рынке (причем у всех
    интересы разные), экономическая политика государства, регулирующие органы. Где тут причина, где следствие, как это
    все взаимодействует и где нужно искать прибыль? Представим машину - колеса эти котировки, двигатель это новости, и
    кабина, в которой сидит стратег. Стратег это тот кто и создает рынок своими решениями, в руках у него коробка
    передач, дергая рычаги он может подать движение двигателя на колеса или нет. А может подать, но в обратную сторону.
    А почему так может быть? Стратег точно также видит какую то неожиданную положительную новость, и при выходе ее у
    него возможность присоединиться к покупкам, но это затруднительно, потому что ему не хватит ликвидность, и тогда
    зачем ему вместе со всеми вставать в покупку чтобы по итоге набрать на 3% от своего капитала, задрав цену? Поэтому
    он может остаться в стороне, не подав движение от двигателя на колеса, а может подать реверсивно и рынок не
    вырастет, а упадет. Я уж не говорю о стратеге-инсайдере, который заранее знает о положительной новости и заранее был
    в рынке. На положительной новости он будет фиксировать свою прибыль, используя ту ликвидность которую создают мелкие
    игроки, пытающиеся отыграть положительную новость. Люди желающие торговать на новостях следят за двигателем, они
    оценивают его мощность, насколько он блестит, как там у него с маслицем и делают вывод что если двигатель в хорошем
    состоянии, то и колеса будут хорошо двигаться в нужную сторону. А для меня информативней подглядывать в кабину
    наблюдая за стратегом, потому что там принимается решение. Кроме того состояние двигателя знают все, а во вторых
    есть такое понятие подгонка решения под задачу - и торгующий на новостях задним числом всегда сможет подогнать под
    движение на рынке какую то новость, поэтому часто создается ложная иллюзия - "торговать на новостях можно, просто я
    неправильно проанализировал". Знающих какой то действительно важный инсайд очень мало, все остальные оперируют
    общедоступной информацией, а общедоступная информация не стоит ничего. А теперь по поводу стратега в кабине - нет
    никакого стратега, это упрощение, все мы сидим в этой кабине и все передаем движение двигателя на колеса. У кого то
    большой депозит у кого то маленький, у кого то один уровень страхов и притязаний, у кого то другой, и все слушают
    новости, перерабатывают их (или думают что перерабатывают), смотрят на котировки, и взаимодействуют друг с другом, с
    целью извлечения прибыли. Так что не сидит кабине какой то один большой манипулятор, который покручивает усик и
    думает как бы всех обмануть, все мы там сидим и все изменяем реальность своими действиями. И все наши желания,
    страхи, невежество перемешиваются и выливают в котировочки. Так что рынок это о теории игр.
</p>